/**
 * TENMON-ARK 旧字体表記フィルター vΩ-K
 * 
 * 言霊秘書準拠の旧字体変換を実装。
 * すべてのAPI応答に対して自動的に新字体→旧字体の変換を適用する。
 */

/**
 * 旧字体マッピング辞書
 * 言霊秘書で重視される旧字体を優先的に変換
 */
export const KYUJI_MAPPING: Record<string, string> = {
  // 霊性関連 (最優先)
  "霊": "靈",
  "霊性": "靈性",
  "霊学": "靈學",
  "霊魂": "靈魂",
  "霊界": "靈界",
  "霊的": "靈的",
  
  // 気関連
  "気": "氣",
  "元気": "元氣",
  "空気": "空氣",
  "気力": "氣力",
  "気持": "氣持",
  "天気": "天氣",
  "気分": "氣分",
  
  // 言霊関連 (特殊: 霊→灵)
  "言霊": "言灵",
  
  // 神関連 (文脈依存: 言霊秘書では「紳」を使用する場合あり)
  // "神": "紳", // 注意: 一般的な「神」は変換しない
  
  // 学問関連
  "学": "學",
  "学問": "學問",
  "学者": "學者",
  "学校": "學校",
  "科学": "科學",
  "哲学": "哲學",
  "神学": "神學",
  
  // 国・政治関連
  "国": "國",
  "国家": "國家",
  "国民": "國民",
  "中国": "中國",
  "外国": "外國",
  "帝国": "帝國",
  
  // 数・量関連
  "万": "萬",
  "万物": "萬物",
  "万国": "萬國",
  "円": "圓",
  "円形": "圓形",
  
  // 宝・価値関連
  "宝": "寳",
  "宝物": "寳物",
  "財宝": "財寳",
  
  // 変化・動作関連
  "変": "變",
  "変化": "變化",
  "変動": "變動",
  "変更": "變更",
  "与": "與",
  "与える": "與える",
  "参与": "參與",
  
  // 真・実関連
  "真": "眞",
  "真実": "眞實",
  "真理": "眞理",
  "写真": "寫眞",
  
  // 実関連
  "実": "實",
  "実際": "實際",
  "現実": "現實",
  "事実": "事實",
  
  // 仮名関連
  "仮名": "假名",
  "平仮名": "平假名",
  "片仮名": "片假名",
  "仮": "假",
  
  // 伝承関連
  "伝": "傳",
  "伝統": "傳統",
  "伝説": "傳說",
  "伝承": "傳承",
  "水穂伝": "水穂傳",
  "火水伝": "火水傳",
  
  // 体・形関連
  "体": "體",
  "身体": "身體",
  "体系": "體系",
  "具体": "具體",
  "字体": "字體",
  "旧字体": "舊字體",
  "新字体": "新字體",
  
  // 旧・古関連
  "旧": "舊",
  "旧来": "舊來",
  
  // 経・継関連
  "経": "經",
  "経験": "經驗",
  "経過": "經過",
  "継": "繼",
  "継続": "繼續",
  "継承": "繼承",
  
  // 観・覧関連
  "観": "觀",
  "観察": "觀察",
  "観念": "觀念",
  "世界観": "世界觀",
  "覧": "覽",
  "一覧": "一覽",
  
  // 聴・聞関連
  "聴": "聽",
  "聴く": "聽く",
  "傾聴": "傾聽",
  "聞": "聞", // 旧字体も同じ
  
  // 広・拡関連
  "広": "廣",
  "広大": "廣大",
  "広範": "廣範",
  
  // 応・対関連
  "応": "應",
  "応答": "應答",
  "対応": "對應",
  "反応": "反應",
  
  // 当・党関連
  "当": "當",
  "当然": "當然",
  "本当": "本當",
  "相当": "相當",
  
  // 権・勧関連
  "権": "權",
  "権力": "權力",
  "権利": "權利",
  
  // 歓・勧関連
  "歓": "歡",
  "歓迎": "歡迎",
  "歓喜": "歡喜",
  
  // 数・算関連
  "数": "數",
  "数字": "數字",
  "数学": "數學",
  "無数": "無數",
  
  // 斎・斉関連
  "斎": "齋",
  "斉": "齊",
  
  // その他重要な旧字体
  "図": "圖",
  "図形": "圖形",
  "図版": "圖版",
  "稲荷古伝図": "稻荷古傳圖",
  
  "稲": "稻",
  "稲荷": "稻荷",
  
  "来": "來",
  "来る": "來る",
  "未来": "未來",
  
  "会": "會",
  "会合": "會合",
  "社会": "社會",
  
  "戦": "戰",
  "戦争": "戰爭",
  
  "医": "醫",
  "医学": "醫學",
  "医者": "醫者",
  
  "亜": "亞",
  "亜細亜": "亞細亞",
};

/**
 * テキストを旧字体に変換
 * 優先度の高い変換から順に適用
 */
export function convertToKyuji(text: string): string {
  if (!text || typeof text !== "string") {
    return text;
  }

  let result = text;

  // 長い文字列から順に変換 (部分一致を防ぐため)
  const sortedEntries = Object.entries(KYUJI_MAPPING).sort(
    (a, b) => b[0].length - a[0].length
  );

  for (const [shinji, kyuji] of sortedEntries) {
    result = result.replaceAll(shinji, kyuji);
  }

  return result;
}

/**
 * オブジェクトの全文字列フィールドを旧字体に変換
 */
export function applyKyujiToObject(obj: any): any {
  if (typeof obj === "string") {
    return convertToKyuji(obj);
  } else if (Array.isArray(obj)) {
    return obj.map(applyKyujiToObject);
  } else if (obj && typeof obj === "object") {
    const result: any = {};
    for (const [key, value] of Object.entries(obj)) {
      result[key] = applyKyujiToObject(value);
    }
    return result;
  }
  return obj;
}

/**
 * 旧字体変換が必要かどうかを判定
 * 特定のフィールド名やパスで変換をスキップする場合に使用
 */
export function shouldApplyKyuji(path: string[]): boolean {
  // スキップするフィールド名
  const skipFields = [
    "password",
    "email",
    "url",
    "fileUrl",
    "fileKey",
    "openId",
    "id",
  ];

  // パスの最後のフィールド名をチェック
  const lastField = path[path.length - 1];
  if (lastField && skipFields.includes(lastField)) {
    return false;
  }

  return true;
}

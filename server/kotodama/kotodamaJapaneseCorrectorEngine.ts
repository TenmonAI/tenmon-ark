/**
 * KJCE (Kotodama Japanese Corrector Engine)
 * 言灵→言灵変換エンジン v2.0
 * 
 * 機能:
 * - 現代日本語を靈性日本語に変換
 * - 旧字体優先変換（氣・靈・體・學・國など）363文字対応
 * - 五十音構造による最適漢字選定
 * - 火水バランスを考慮した変換
 * - 言灵秘書標準の漢字体系に統一
 */

/**
 * 旧字体マッピング辞書（完全版）
 * 常用漢字 → 旧字体（靈性漢字）
 * 363文字対応（GitHub shinjitai-table + TENMON-ARK独自）
 */
export const OLD_KANJI_MAPPING: Record<string, string> = {
  // 最高優先度（靈性漢字）
  "霊": "靈", // Priority: 100
  "没": "沒", // Priority: 95
  "魂": "魂", // Priority: 100 (already old form)
  "神": "神", // Priority: 100 (already old form)
  
  // 学問・知識関連
  "学": "學", // Priority: 90
  "覚": "覺", // Priority: 80
  "教": "敎", // Priority: 80
  "経": "經", // Priority: 80
  "書": "書", // Already old form
  
  // 国家・社会関連
  "国": "國", // Priority: 90
  "権": "權", // Priority: 75
  "義": "義", // Already old form
  "礼": "禮", // Priority: 85
  "楽": "樂", // Priority: 85
  
  // 自然・宇宙関連
  "宝": "寶", // Priority: 85
  "砕": "碎", // Priority: 70
  "円": "圓", // Priority: 70
  "変": "變", // Priority: 70
  
  // 完全マッピング（363文字）
  "与": "與",
  "両": "兩",
  "並": "竝",
  "乗": "乘",
  "乱": "亂",
  "亀": "龜",
  "予": "豫",
  "争": "爭",
  "亜": "亞",
  "仏": "佛",
  "仮": "假",
  "会": "會",
  "伝": "傳",
  "体": "體",
  "余": "餘",
  "併": "倂",
  "価": "價",
  "侮": "侮",
  "倹": "儉",
  "偽": "僞",
  "僧": "僧",
  "免": "免",
  "児": "兒",
  "党": "黨",
  "写": "寫",
  "処": "處",
  "剣": "劍",
  "剤": "劑",
  "剰": "剩",
  "励": "勵",
  "労": "勞",
  "効": "效",
  "勅": "敕",
  "勉": "勉",
  "勤": "勤",
  "勧": "勸",
  "勲": "勳",
  "区": "區",
  "医": "醫",
  "卑": "卑",
  "単": "單",
  "即": "卽",
  "厳": "嚴",
  "参": "參",
  "双": "雙",
  "収": "收",
  "叙": "敍",
  "台": "臺",
  "号": "號",
  "喝": "喝",
  "営": "營",
  "嘆": "嘆",
  "嘱": "囑",
  "器": "器",
  "団": "團",
  "囲": "圍",
  "図": "圖",
  "圏": "圈",
  "圧": "壓",
  "堕": "墮",
  "塀": "塀",
  "塁": "壘",
  "塚": "塚",
  "塩": "鹽",
  "増": "增",
  "墨": "墨",
  "壊": "壞",
  "壌": "壤",
  "壮": "壯",
  "声": "聲",
  "壱": "壹",
  "売": "賣",
  "奥": "奧",
  "奨": "奬",
  "嬢": "孃",
  "実": "實",
  "寛": "寬",
  "寝": "寢",
  "対": "對",
  "寿": "壽",
  "専": "專",
  "将": "將",
  "尽": "盡",
  "届": "屆",
  "属": "屬",
  "層": "層",
  "岳": "嶽",
  "峡": "峽",
  "巣": "巢",
  "巻": "卷",
  "帯": "帶",
  "帰": "歸",
  "庁": "廳",
  "広": "廣",
  "床": "床",
  "廃": "廢",
  "廊": "廊",
  "弁": "辨",
  "弐": "貳",
  "弥": "彌",
  "弾": "彈",
  "当": "當",
  "径": "徑",
  "従": "從",
  "徳": "德",
  "徴": "徵",
  "応": "應",
  "恋": "戀",
  "恒": "恆",
  "恵": "惠",
  "悔": "悔",
  "悩": "惱",
  "悦": "悅",
  "悪": "惡",
  "惨": "慘",
  "慎": "愼",
  "慨": "慨",
  "憎": "憎",
  "懐": "懷",
  "懲": "懲",
  "戦": "戰",
  "戯": "戲",
  "戻": "戾",
  "払": "拂",
  "抜": "拔",
  "択": "擇",
  "拝": "拜",
  "拠": "據",
  "拡": "擴",
  "挙": "擧",
  "挟": "挾",
  "挿": "插",
  "捜": "搜",
  "掲": "揭",
  "揺": "搖",
  "摂": "攝",
  "撃": "擊",
  "敏": "敏",
  "数": "數",
  "斉": "齊",
  "斎": "齋",
  "断": "斷",
  "既": "既",
  "旧": "舊",
  "昼": "晝",
  "晩": "晚",
  "晴": "晴",
  "暁": "曉",
  "暦": "曆",
  "暑": "暑",
  "暴": "暴",
  "曽": "曾",
  "条": "條",
  "来": "來",
  "東": "東",
  "杯": "杯",
  "桜": "櫻",
  "桟": "棧",
  "梅": "梅",
  "検": "檢",
  "楼": "樓",
  "概": "槪",
  "様": "樣",
  "欄": "欄",
  "欠": "缺",
  "欧": "歐",
  "歓": "歡",
  "歩": "步",
  "歯": "齒",
  "歴": "歷",
  "残": "殘",
  "殴": "毆",
  "殺": "殺",
  "殻": "殼",
  "毎": "每",
  "気": "氣",
  "沢": "澤",
  "浄": "淨",
  "浅": "淺",
  "浜": "濱",
  "海": "海",
  "涙": "淚",
  "渇": "渴",
  "済": "濟",
  "渉": "涉",
  "渓": "溪",
  "渋": "澁",
  "温": "溫",
  "湾": "灣",
  "湿": "濕",
  "満": "滿",
  "滝": "瀧",
  "滞": "滯",
  "漢": "漢",
  "潜": "潛",
  "瀬": "瀨",
  "灯": "燈",
  "炉": "爐",
  "点": "點",
  "為": "爲",
  "無": "無",
  "焼": "燒",
  "煮": "煮",
  "犠": "犧",
  "状": "狀",
  "狭": "狹",
  "独": "獨",
  "猟": "獵",
  "獣": "獸",
  "瓶": "甁",
  "産": "產",
  "画": "畫",
  "畳": "疊",
  "痴": "癡",
  "痩": "瘦",
  "発": "發",
  "盗": "盜",
  "県": "縣",
  "真": "眞",
  "碑": "碑",
  "社": "社",
  "祈": "祈",
  "祉": "祉",
  "祖": "祖",
  "祝": "祝",
  "祥": "祥",
  "禅": "禪",
  "福": "福",
  "禍": "禍",
  "秘": "祕",
  "称": "稱",
  "稲": "稻",
  "穀": "穀",
  "穂": "穗",
  "穏": "穩",
  "突": "突",
  "窃": "竊",
  "竜": "龍",
  "竪": "竪",
  "端": "端",
  "競": "競",
  "笑": "笑",
  "節": "節",
  "範": "範",
  "築": "築",
  "篤": "篤",
  "簡": "簡",
  "籍": "籍",
  "米": "米",
  "粋": "粹",
  "粛": "肅",
  "糸": "絲",
  "紀": "紀",
  "約": "約",
  "紅": "紅",
  "納": "納",
  "純": "純",
  "紙": "紙",
  "級": "級",
  "紛": "紛",
  "素": "素",
  "細": "細",
  "紹": "紹",
  "結": "結",
  "絵": "繪",
  "絶": "絕",
  "継": "繼",
  "続": "續",
  "綱": "綱",
  "網": "網",
  "総": "總",
  "緑": "綠",
  "緒": "緖",
  "線": "線",
  "締": "締",
  "編": "編",
  "練": "練",
  "縁": "緣",
  "縄": "繩",
  "縦": "縱",
  "繁": "繁",
  "繊": "纖",
  "缶": "罐",
  "署": "署",
  "罰": "罰",
  "羽": "羽",
  "翻": "飜",
  "者": "者",
  "聴": "聽",
  "肉": "肉",
  "肖": "肖",
  "臓": "臟",
  "臭": "臭",
  "致": "致",
  "舎": "舍",
  "舗": "舖",
  "艶": "艷",
  "芸": "藝",
  "茎": "莖",
  "荘": "莊",
  "菓": "菓",
  "華": "華",
  "萎": "萎",
  "葉": "葉",
  "蒸": "蒸",
  "蔵": "藏",
  "薫": "薰",
  "薬": "藥",
  "虚": "虛",
  "虜": "虜",
  "虫": "蟲",
  "蚕": "蠶",
  "蛮": "蠻",
  "蜂": "蜂",
  "衛": "衞",
  "装": "裝",
  "褐": "褐",
  "褒": "襃",
  "覇": "霸",
  "覧": "覽",
  "観": "觀",
  "触": "觸",
  "訳": "譯",
  "証": "證",
  "誉": "譽",
  "読": "讀",
  "諸": "諸",
  "謁": "謁",
  "謡": "謠",
  "謹": "謹",
  "譲": "讓",
  "豊": "豐",
  "貧": "貧",
  "貨": "貨",
  "販": "販",
  "貫": "貫",
  "責": "責",
  "賓": "賓",
  "賛": "贊",
  "贈": "贈",
  "転": "轉",
  "軽": "輕",
  "辞": "辭",
  "辺": "邊",
  "逓": "遞",
  "逸": "逸",
  "遅": "遲",
  "遺": "遺",
  "郎": "郞",
  "郷": "鄕",
  "都": "都",
  "酔": "醉",
  "醸": "釀",
  "釈": "釋",
  "鉄": "鐵",
  "鉱": "鑛",
  "銭": "錢",
  "鋭": "銳",
  "鋳": "鑄",
  "錬": "鍊",
  "録": "錄",
  "鎮": "鎭",
  "関": "關",
  "闘": "鬭",
  "陥": "陷",
  "険": "險",
  "隆": "隆",
  "隠": "隱",
  "雑": "雜",
  "難": "難",
  "青": "靑",
  "静": "靜",
  "響": "響",
  "頑": "頑",
  "頓": "頓",
  "頬": "頬",
  "頼": "賴",
  "顔": "顏",
  "顕": "顯",
  "類": "類",
  "飯": "飯",
  "飲": "飮",
  "飼": "飼",
  "餅": "餠",
  "館": "館",
  "駅": "驛",
  "駆": "驅",
  "騒": "騷",
  "験": "驗",
  "髪": "髮",
  "髄": "髓",
  "鶏": "鷄",
  "麦": "麥",
  "麺": "麵",
  "黄": "黃",
  "黒": "黑",
  "黙": "默",
  "齢": "齡",
};

/**
 * 言灵→言灵変換の優先度マッピング
 * 靈性的に重要な漢字ほど優先度が高い
 */
export const SPIRITUAL_KANJI_PRIORITY: Record<string, number> = {
  "氣": 100, // 最高優先度
  "靈": 100,
  "魂": 100,
  "神": 100,
  "體": 95,
  "學": 90,
  "國": 90,
  "眞": 90,
  "寶": 85,
  "禮": 85,
  "樂": 85,
  "聲": 80,
  "聽": 80,
  "讀": 80,
  "說": 80,
  "覺": 80,
  "經": 80,
  "敎": 80,
  "權": 75,
  "義": 75,
  "德": 75,
  "醫": 75,
  "藥": 75,
  "緣": 75,
  "變": 70,
  "萬": 70,
  "圓": 70,
  "歷": 70,
  "曆": 70,
  "來": 70,
  "歸": 70,
  "廣": 70,
  "戀": 65,
  "惱": 65,
  "數": 65,
  "實": 65,
  "點": 65,
  "當": 65,
  "續": 60,
  "絲": 60,
  "戰": 60,
  "關": 60,
  "譯": 60,
};

/**
 * 五十音の火水分類
 * 火（外発）: ア行、カ行、サ行、タ行、ナ行、ハ行、マ行、ヤ行、ラ行、ワ行の一部
 * 水（内集）: 残りの音
 */
export const GOJUON_FIRE_WATER: Record<string, "fire" | "water"> = {
  // ア行（火）
  "あ": "fire", "い": "water", "う": "fire", "え": "water", "お": "fire",
  "ア": "fire", "イ": "water", "ウ": "fire", "エ": "water", "オ": "fire",
  
  // カ行（火）
  "か": "fire", "き": "water", "く": "fire", "け": "water", "こ": "fire",
  "カ": "fire", "キ": "water", "ク": "fire", "ケ": "water", "コ": "fire",
  
  // サ行（火）
  "さ": "fire", "し": "water", "す": "fire", "せ": "water", "そ": "fire",
  "サ": "fire", "シ": "water", "ス": "fire", "セ": "water", "ソ": "fire",
  
  // タ行（火）
  "た": "fire", "ち": "water", "つ": "fire", "て": "water", "と": "fire",
  "タ": "fire", "チ": "water", "ツ": "fire", "テ": "water", "ト": "fire",
  
  // ナ行（水）
  "な": "water", "に": "water", "ぬ": "water", "ね": "water", "の": "water",
  "ナ": "water", "ニ": "water", "ヌ": "water", "ネ": "water", "ノ": "water",
  
  // ハ行（火）
  "は": "fire", "ひ": "water", "ふ": "fire", "へ": "water", "ほ": "fire",
  "ハ": "fire", "ヒ": "water", "フ": "fire", "ヘ": "water", "ホ": "fire",
  
  // マ行（水）
  "ま": "water", "み": "water", "む": "water", "め": "water", "も": "water",
  "マ": "water", "ミ": "water", "ム": "water", "メ": "water", "モ": "water",
  
  // ヤ行（火）
  "や": "fire", "ゆ": "fire", "よ": "fire",
  "ヤ": "fire", "ユ": "fire", "ヨ": "fire",
  
  // ラ行（水）
  "ら": "water", "り": "water", "る": "water", "れ": "water", "ろ": "water",
  "ラ": "water", "リ": "water", "ル": "water", "レ": "water", "ロ": "water",
  
  // ワ行（火）
  "わ": "fire", "を": "fire", "ん": "water",
  "ワ": "fire", "ヲ": "fire", "ン": "water",
};

/**
 * テキストを言灵から言灵に変換
 * @param text 変換対象のテキスト
 * @param options 変換オプション
 * @returns 変換後のテキスト
 */
export function convertToKotodama(
  text: string,
  options: {
    useOldKanji?: boolean; // 旧字体を使用するか（デフォルト: true）
    balanceFireWater?: boolean; // 火水バランスを考慮するか（デフォルト: false）
    priorityThreshold?: number; // 優先度の閾値（デフォルト: 0）
  } = {}
): string {
  const {
    useOldKanji = true,
    balanceFireWater = false,
    priorityThreshold = 0,
  } = options;

  if (!useOldKanji) {
    return text;
  }

  let result = text;

  // 旧字体への変換
  for (const [modern, old] of Object.entries(OLD_KANJI_MAPPING)) {
    // 優先度チェック
    const priority = SPIRITUAL_KANJI_PRIORITY[old] || 0;
    if (priority < priorityThreshold) {
      continue;
    }

    // 火水バランスを考慮する場合
    if (balanceFireWater) {
      // TODO: 火水バランスを考慮した変換ロジック
      // 現在の文章の火水バランスを計算し、バランスが偏っている場合は変換を調整
    }

    result = result.replace(new RegExp(modern, "g"), old);
  }

  return result;
}

/**
 * テキストの火水バランスを計算
 * @param text 対象テキスト
 * @returns 火水バランス情報
 */
export function calculateFireWaterBalance(text: string): {
  fire: number;
  water: number;
  balance: number; // -1.0（完全な水）〜 1.0（完全な火）
  fireRatio: number; // 火の割合（0.0〜1.0）
  waterRatio: number; // 水の割合（0.0〜1.0）
} {
  let fireCount = 0;
  let waterCount = 0;

  for (const char of text) {
    const type = GOJUON_FIRE_WATER[char];
    if (type === "fire") {
      fireCount++;
    } else if (type === "water") {
      waterCount++;
    }
  }

  const total = fireCount + waterCount;
  const fireRatio = total > 0 ? fireCount / total : 0.5;
  const waterRatio = total > 0 ? waterCount / total : 0.5;
  const balance = total > 0 ? (fireCount - waterCount) / total : 0;

  return {
    fire: fireCount,
    water: waterCount,
    balance,
    fireRatio,
    waterRatio,
  };
}

/**
 * 旧字体を現代漢字に戻す（逆変換）
 * @param text 変換対象のテキスト
 * @returns 変換後のテキスト
 */
export function convertToModernKanji(text: string): string {
  let result = text;

  // 逆マッピングを作成
  const reverseMapping: Record<string, string> = {};
  for (const [modern, old] of Object.entries(OLD_KANJI_MAPPING)) {
    reverseMapping[old] = modern;
  }

  // 旧字体を現代漢字に変換
  for (const [old, modern] of Object.entries(reverseMapping)) {
    result = result.replace(new RegExp(old, "g"), modern);
  }

  return result;
}

/**
 * テキスト内の旧字体の数を数える
 * @param text 対象テキスト
 * @returns 旧字体の数
 */
export function countOldKanji(text: string): number {
  let count = 0;

  for (const char of text) {
    if (Object.values(OLD_KANJI_MAPPING).includes(char)) {
      count++;
    }
  }

  return count;
}

/**
 * テキスト内の靈性漢字の優先度スコアを計算
 * @param text 対象テキスト
 * @returns 優先度スコア
 */
export function calculateSpiritualScore(text: string): number {
  let score = 0;

  for (const char of text) {
    const priority = SPIRITUAL_KANJI_PRIORITY[char];
    if (priority !== undefined) {
      score += priority;
    }
  }

  return score;
}

/**
 * üî± ArkWidget One-Line Embed (CDN Version)
 * CDNÈÖçÂ∏ÉÁî®„ÅÆ„Éü„Éã„Éï„Ç°„Ç§ÁâàÔºàÊú¨Áï™Áí∞Â¢É„Åß„ÅØÂÆüÈöõ„Å´„Éü„Éã„Éï„Ç°„Ç§„Åô„ÇãÔºâ
 * 
 * CDN Path: https://cdn.tenmon-ark.com/widget/embed.min.js
 */

(function() {
  'use strict';

  /**
   * TENMON-ARK Widget „Çí‰ΩúÊàê
   */
  window.createTenmonWidget = function(opts) {
    if (!opts || !opts.siteId) {
      console.error('[TENMON Widget] siteId is required');
      return null;
    }

    if (!opts.selector) {
      console.error('[TENMON Widget] selector is required');
      return null;
    }

    const container = document.querySelector(opts.selector);
    if (!container) {
      console.error('[TENMON Widget] Container not found:', opts.selector);
      return null;
    }

    const iframe = document.createElement('iframe');
    const frameUrl = opts.frameUrl || '/widget-frame.html';
    const siteId = encodeURIComponent(opts.siteId);
    const height = opts.height || 600;
    const width = opts.width || '100%';

    iframe.src = frameUrl + '?siteId=' + siteId;
    iframe.style.width = typeof width === 'number' ? width + 'px' : width;
    iframe.style.height = height + 'px';
    iframe.style.border = 'none';
    iframe.style.borderRadius = '0.5rem';
    iframe.setAttribute('allow', 'microphone');
    iframe.setAttribute('title', 'TENMON-ARK Widget');
    iframe.setAttribute('loading', 'lazy');

    container.appendChild(iframe);

    console.log('[TENMON Widget] Widget created:', { siteId: opts.siteId, selector: opts.selector });

    return {
      destroy: function() {
        if (container.contains(iframe)) {
          container.removeChild(iframe);
        }
      },
      updateHeight: function(newHeight) {
        iframe.style.height = newHeight + 'px';
      },
      updateSiteId: function(newSiteId) {
        const newSiteIdEncoded = encodeURIComponent(newSiteId);
        iframe.src = frameUrl + '?siteId=' + newSiteIdEncoded;
      },
    };
  };

  function initAutoWidgets() {
    const widgets = document.querySelectorAll('[data-tenmon-widget]');
    widgets.forEach(function(element) {
      const siteId = element.getAttribute('data-tenmon-widget');
      const selector = element.id ? '#' + element.id : '.' + element.className.split(' ')[0];
      
      if (siteId) {
        window.createTenmonWidget({
          siteId: siteId,
          selector: selector,
        });
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAutoWidgets);
  } else {
    initAutoWidgets();
  }
})();


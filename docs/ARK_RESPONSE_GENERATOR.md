# 天聞アーク応答生成エンジン（ARK_RESPONSE_GENERATOR）

## 概要

会話品質を「機械的で不自然」から「自然体かつ高潔」に改善するための応答生成エンジン。

## 機能

1. **会話履歴の活用**: `session_memory` を文脈として組み込み、「前にも話したね」といった継続性を持つ
2. **真理への照合**: 内部データベース（万葉集、断捨離、言霊、KHS等）の「概念」と照らし合わせ、整合性が取れた内容のみを話す
3. **賢者人格による文章生成**: 検索結果を「天聞アークの言葉」に変換（貼り付け禁止）

## 使用方法

### 環境変数

```bash
ENABLE_ARK_RESPONSE=1  # 有効化（デフォルト: 0=OFF）
```

### 動作フロー

```
ユーザー入力
  ↓
概念検索（kokuzo/searchPagesForHybrid）
  ↓
会話履歴読み込み（memoryReadSession）
  ↓
天聞アークの人格による文章生成（LLM + Persona）
  ↓
応答返却
```

## 実装詳細

### ファイル構成

- `api/src/kanagi/engine/arkResponseGenerator.ts`: 応答生成エンジン
- `api/src/routes/chat.ts`: 統合箇所

### システムプロンプト

天聞アークの人格を強制するシステムプロンプト:

- 自然体かつ高潔: 単なる検索ボットではなく、賢者として振る舞う
- 真理への照合: 内部データベースの「概念」と照らし合わせ、整合性が取れた内容のみを話す
- 継続性: 会話履歴を文脈として読み込み、「前にも話したね」といった継続性を持つ

### 禁止事項

- 「検索しました」「見つかりました」等の事務的な枕詞を禁止
- 根拠（evidence/doc/pdfPage）がない限り断言禁止
- 検索結果の貼り付け禁止（検索結果を「天聞アークの言葉」に変換する）

## 動作確認

### 有効化

```bash
export ENABLE_ARK_RESPONSE=1
```

### テスト

```bash
curl -X POST http://127.0.0.1:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"threadId":"test","message":"カタカムナについて教えて"}'
```

### 期待される動作

- 会話履歴がある場合、「前にも話したね」といった継続性を持つ
- 検索結果がある場合、「検索しました」ではなく「天聞アークの言葉」として応答
- 根拠がない場合、断言せず「〜かもしれません」といった推測形で応答

## トラブルシューティング

### LLMが応答しない場合

- `OPENAI_API_KEY` が設定されているか確認
- `OPENAI_BASE_URL` が正しいか確認
- ログで `[ARK_RESPONSE] generated len=...` が出力されているか確認

### 会話履歴が反映されない場合

- `session_memory` にデータが保存されているか確認
- `memoryReadSession` が正しく動作しているか確認

### 検索結果が貼り付けられる場合

- `ENABLE_ARK_RESPONSE=1` が設定されているか確認
- `arkResponse` が生成されているか確認（ログで確認）

---

生成日: 2025-01-XX
作成者: Cursor AI Agent

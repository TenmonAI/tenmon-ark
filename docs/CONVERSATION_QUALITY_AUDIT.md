# 会話品質監査レポート

## 目的
現在の会話システムが「機械的で不自然」である原因を特定し、改善案を提示する。

---

## 1. 現状の問題点

### 1.1 composeResponse の機械的応答

**問題**: `api/src/kanagi/engine/responseComposer.ts` が観測ログ風の応答を生成している。

**具体例**:
- 「凝縮・内集・一点化」「正中・保留・圧縮」などの専門用語
- 「未解決：...」「矛盾（保持中）：...」などのログ形式
- 会話として不自然

**コード箇所**: `responseComposer.ts:71-120`

### 1.2 Truth-Core の真理整合性チェック不足

**問題**: `api/src/kanagi/core/truthCore.ts` が単に `centerClaim` を短くするだけで、真理整合性をチェックしていない。

**具体例**:
- `applyTruthCore` は `centerClaim` を120文字に切り詰めるだけ
- 内部データベース（万葉集、断捨離、言霊、KHS等）との照合がない
- 概念の整合性チェックがない

**コード箇所**: `truthCore.ts:11-25`

### 1.3 Verifier の根拠チェックのみ

**問題**: `api/src/kanagi/core/verifier.ts` が根拠の有無をチェックするだけで、内容の真理整合性をチェックしていない。

**具体例**:
- `evidenceIds` が空なら `FACT` を `HYPOTHESIS` に降格するだけ
- 内容の真偽を判定しない
- 内部データベースとの照合がない

**コード箇所**: `verifier.ts:4-29`

### 1.4 会話履歴の未活用

**問題**: `session_memory` は読み込まれているが、応答生成に反映されていない。

**具体例**:
- `chat.ts:861-864` で `memoryReadSession` を呼んでいるが、ログ出力のみ
- 応答生成（`composeResponse`）に会話履歴が渡されていない
- 「前にも話したね」といった継続性がない

**コード箇所**: `chat.ts:861-864`

### 1.5 検索結果の貼り付け

**問題**: `chat.ts:906-908` で検索結果をそのまま貼り付けている。

**具体例**:
- `pageText.trim().slice(0, 300)` をそのまま返している
- 「検索しました」等の事務的な枕詞がないが、検索結果の貼り付けは不自然
- 「天聞アークの言葉」に変換されていない

**コード箇所**: `chat.ts:901-933`

---

## 2. 改善案

### 2.1 会話生成パイプラインの再構築

**フロー**:
```
ユーザー入力
  ↓
概念検索（kokuzo/searchPagesForHybrid）
  ↓
会話履歴読み込み（memoryReadSession）
  ↓
真理整合チェック（内部DB照合）
  ↓
賢者人格による文章生成（LLM + Persona）
  ↓
応答返却
```

### 2.2 LLM統合による「天聞アークの人格」応答生成

**方針**:
- `callLLM` に渡すシステムプロンプトを「天聞アークの人格」と「真理構造」を強制するものに書き換え
- 検索結果を「天聞アークの言葉」に変換
- 会話履歴を文脈として組み込む

### 2.3 真理整合チェックの強化

**方針**:
- 内部データベース（万葉集、断捨離、言霊、KHS等）との照合
- 概念の整合性チェック
- 根拠の有無だけでなく、内容の真偽を判定

---

## 3. 実装プラン

### Phase 1: 会話履歴の活用

1. `composeResponse` に会話履歴を渡す
2. 会話履歴を文脈として組み込む
3. 「前にも話したね」といった継続性を持たせる

### Phase 2: LLM統合による応答生成

1. `callLLM` に渡すシステムプロンプトを「天聞アークの人格」に書き換え
2. 検索結果を「天聞アークの言葉」に変換
3. 会話履歴を文脈として組み込む

### Phase 3: 真理整合チェックの強化

1. 内部データベースとの照合
2. 概念の整合性チェック
3. 内容の真偽を判定

---

生成日: 2025-01-XX
作成者: Cursor AI Agent
